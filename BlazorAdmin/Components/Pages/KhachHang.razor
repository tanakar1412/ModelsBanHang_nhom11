@page "/khachhang"
@using System.Globalization
@using Data.Models
@inject IKhachHangService KhachHangService
@inject NavigationManager NavigationManager

<link href="/css/KhachHang.css" rel="stylesheet" />

<div class="card">
    <div class="top-controls">
        <div>
            <input type="text" placeholder="🔍 Tìm kiếm tên, sđt hoặc email" @bind="SearchTerm" @bind:event="oninput" />
            <button class="btn" @onclick="ExportExcel">Xuất Excel</button>
        </div>
        <button class="btn" @onclick="NavigateToCreate">+ Tạo khách hàng</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>STT</th>
                <th>Họ tên</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Ngày sinh</th>
                <th>Trạng thái</th>
                <th>Ngày tạo</th>
                <th>Ngày cập nhật</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @if (FilteredCustomers.Any())
            {
                @foreach (var (c, index) in FilteredCustomers.Select((c, i) => (c, i)))
                {
                    <tr>
                        <td>@(index + 1)</td>
                        <td>@c.HoTen</td>
                        <td>@c.Email</td>
                        <td>@c.SoDienThoai</td>
                        <td>@FormatDate(c.NgaySinh)</td>
                        <td><span class="status">@(c.TrangThai ? "Hoạt động" : "Ngưng hoạt động")</span></td>
                        <td>@FormatDate(c.NgayTao)</td>
                        <td>@FormatDate(c.NgayCapNhatCuoiCung)</td>
                        <td>
                            <button class="btn-action" @onclick="() => ViewCustomer(c.KhachHangId)">👁️ Xem</button>
                            <button class="btn-action" @onclick="() => EditCustomer(c.KhachHangId)">✏️ Sửa</button>
                            <button class="btn-action" @onclick="() => DeleteCustomer(c.KhachHangId)">🗑️ Xóa</button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="text-center">Không có dữ liệu</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private List<KhachHang> Customers = new();
    private string SearchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Customers = await KhachHangService.GetAll();
    }

    private IEnumerable<KhachHang> FilteredCustomers => Customers.Where(c =>
        string.IsNullOrWhiteSpace(SearchTerm) ||
        c.HoTen.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
        c.Email.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
        c.SoDienThoai.Contains(SearchTerm)
    );

    private string FormatDate(DateTime d) => d.ToString("dd/MM/yyyy", CultureInfo.InvariantCulture);

    private void NavigateToCreate() => NavigationManager.NavigateTo("/themkhachhang");

    private void ExportExcel() => Console.WriteLine("Export Excel clicked");

    private void ViewCustomer(Guid id) => Console.WriteLine($"View customer with ID: {id}");
    private void EditCustomer(Guid id) => Console.WriteLine($"Edit customer with ID: {id}");
    private void DeleteCustomer(Guid id) => Console.WriteLine($"Delete customer with ID: {id}");
}